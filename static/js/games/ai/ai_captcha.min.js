function initCaptchaGame(roomName,stageName,winToken){const progressBarDots=document.querySelectorAll('.progress-dot');const promptEl=document.getElementById('prompt');const imageGrid=document.getElementById('image-grid');const submitBtn=document.getElementById('submit-btn');const feedbackMessage=document.getElementById('feedback-message');const STAGES_TO_WIN=3;const IMAGE_PATH='/static/img/captcha_game/';const puzzleBank=[{prompt:"Selecciona la imagen que contiene un error de generación de IA.",images:['hand_normal_1.jpg','hand_6_fingers.jpg','hand_normal_2.jpg','face_normal_1.jpg','face_normal_2.jpg','face_normal_3.jpg','text_normal.jpg','text_weird.jpg','text_normal_2.jpg'],correctIndices:[1,7]},{prompt:"Selecciona la imagen que evoca 'tranquilidad'.",images:['storm.jpg','traffic_jam.jpg','protest.jpg','serene_lake.jpg','warzone.jpg','factory.jpg','library.jpg','beach_sunset.jpg','heavy_metal_concert.jpg'],correctIndices:[3,6,7]},{prompt:"Selecciona el objeto que no pertenece al grupo.",images:['hammer.jpg','screwdriver.jpg','wrench.jpg','saw.jpg','apple.jpg','drill.jpg','pliers.jpg','tape_measure.jpg','axe.jpg'],correctIndices:[4]},];let completedStages=0;let currentPuzzle;let selectedIndices=[];let availablePuzzles=[];function shuffle(array){for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]];}
return array;}
function startGame(){completedStages=0;availablePuzzles=shuffle([...puzzleBank]);updateProgressUI();loadNextPuzzle();}
function loadNextPuzzle(){selectedIndices=[];feedbackMessage.textContent='';submitBtn.disabled=false;if(availablePuzzles.length===0){availablePuzzles=shuffle([...puzzleBank]);}
currentPuzzle=availablePuzzles.pop();promptEl.textContent=currentPuzzle.prompt;imageGrid.innerHTML='';currentPuzzle.images.forEach((imgFile,index)=>{const img=document.createElement('img');img.src=IMAGE_PATH+imgFile;img.classList.add('grid-image');img.dataset.index=index;img.onclick=()=>handleImageClick(img,index);imageGrid.appendChild(img);});}
function handleImageClick(imgElement,index){const selectedIndex=selectedIndices.indexOf(index);if(selectedIndex>-1){selectedIndices.splice(selectedIndex,1);imgElement.classList.remove('selected');}else{selectedIndices.push(index);imgElement.classList.add('selected');}}
function checkAnswer(){submitBtn.disabled=true;const correct=currentPuzzle.correctIndices;const isCorrect=correct.length===selectedIndices.length&&correct.every(index=>selectedIndices.includes(index));if(isCorrect){completedStages++;updateProgressUI();showFeedback('Verificación aceptada. Procediendo al siguiente nivel...',true);setTimeout(()=>{if(completedStages>=STAGES_TO_WIN){endGame(true);}else{loadNextPuzzle();}},1500);}else{showFeedback('Anomalía detectada. Reiniciando protocolo de verificación...',false);setTimeout(loadNextPuzzle,1500);}}
function showFeedback(message,isSuccess){feedbackMessage.textContent=message;feedbackMessage.style.color=isSuccess?'var(--correct)':'var(--incorrect)';}
function updateProgressUI(){progressBarDots.forEach((dot,index)=>{if(index<completedStages){dot.classList.add('completed');}else{dot.classList.remove('completed');}});}
function endGame(didWin){if(didWin){promptEl.textContent="Verificación Humana Completa";feedbackMessage.textContent="Acceso concedido.";feedbackMessage.style.color='var(--correct)';imageGrid.innerHTML='';submitBtn.style.display='none';setTimeout(()=>submitWin(roomName,stageName,winToken),2000);}}
submitBtn.addEventListener('click',checkAnswer);startGame();}