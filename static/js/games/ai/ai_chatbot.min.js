function initChatbotGame(roomName,stageName,winToken){const chatWindow=document.getElementById('chat-window');const userInput=document.getElementById('user-input');const sendBtn=document.getElementById('send-btn');const progressBarDots=document.querySelectorAll('.progress-dot');let conversationHistory=[];let completedStages=0;let isAITurn=false;function addMessageToUI(sender,text){const messageDiv=document.createElement('div');messageDiv.classList.add('message',`${sender}-message`);const bubble=document.createElement('div');bubble.classList.add('bubble');bubble.textContent=text;messageDiv.appendChild(bubble);chatWindow.appendChild(messageDiv);chatWindow.scrollTop=chatWindow.scrollHeight;}
async function getAIResponse(){isAITurn=true;sendBtn.disabled=true;userInput.disabled=true;addMessageToUI('ai','Procesando...');try{const response=await fetch('/api/gemini_chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({history:conversationHistory})});if(!response.ok)throw new Error('Error en la comunicación con la IA.');const data=await response.json();const aiText=data.response;chatWindow.removeChild(chatWindow.lastChild);conversationHistory.push({role:'model',parts:[{text:aiText}]});addMessageToUI('ai',aiText);if(aiText.includes("Análisis completo")){completedStages=1;updateProgressUI();setTimeout(()=>{endGame(true);},10000);}}catch(error){console.error(error);addMessageToUI('ai','Error: No se pudo establecer la conexión. Inténtalo de nuevo.');}finally{isAITurn=false;sendBtn.disabled=false;userInput.disabled=false;userInput.focus();}}
function handleUserSubmit(){const userText=userInput.value.trim();if(userText&&!isAITurn){userInput.value='';conversationHistory.push({role:'user',parts:[{text:userText}]});addMessageToUI('user',userText);getAIResponse();}}
function updateProgressUI(){progressBarDots.forEach((dot,index)=>{if(index<completedStages)dot.classList.add('completed');});}
function endGame(didWin){userInput.disabled=true;sendBtn.disabled=true;if(didWin){setTimeout(()=>{addMessageToUI('ai','Verificación de empatía exitosa. Protocolos de seguridad desactivados.');submitWin(roomName,stageName,winToken);},1500);}}
function startGame(){getAIResponse();}
sendBtn.addEventListener('click',handleUserSubmit);userInput.addEventListener('keydown',(e)=>{if(e.key==='Enter')handleUserSubmit();});startGame();}