function initCraftingEnigmaGame(roomName,stageName,winToken){const riddleText=document.getElementById('riddle-text');const craftingGrid=document.getElementById('crafting-grid');const inventory=document.getElementById('inventory');const craftButton=document.getElementById('craft-button');const feedback=document.getElementById('feedback');const itemTextures={stick:'https://p.novaskin.me/4905183964.png',diamond:'https://p.novaskin.me/4889073312.png',iron_ingot:'https://p.novaskin.me/4343813293.png',gold_ingot:'https://p.novaskin.me/1811033392.png',ender_pearl:'https://p.novaskin.me/5214243120.png',blaze_powder:'https://p.novaskin.me/4451473145.png',};const riddles=[{riddle:"Con tres joyas celestes y dos esencias del bosque, fabrico la garra que muerde la piedra y jamás se quiebra.",ingredients:['diamond','diamond','diamond','stick','stick'].sort(),result:'diamond_pickaxe'},{riddle:"Un fragmento del vacío y el fuego de las profundidades se unen para abrir portales prohibidos.",ingredients:['ender_pearl','blaze_powder'].sort(),result:'eye_of_ender'}];let gridState=Array(9).fill(null);let currentRiddle;let draggedElement=null;function setupGame(){currentRiddle=riddles[Math.floor(Math.random()*riddles.length)];riddleText.textContent=currentRiddle.riddle;gridState.fill(null);craftingGrid.innerHTML='';for(let i=0;i<9;i++){const slot=document.createElement('div');slot.classList.add('grid-slot');slot.dataset.index=i;slot.addEventListener('dragover',(e)=>e.preventDefault());slot.addEventListener('drop',onDropToGrid);craftingGrid.appendChild(slot);}
inventory.innerHTML='';inventory.addEventListener('dragover',(e)=>e.preventDefault());inventory.addEventListener('drop',onDropToInventory);const allItems=Object.keys(itemTextures);const distractors=allItems.filter(item=>!currentRiddle.ingredients.includes(item)).sort(()=>0.5-Math.random()).slice(0,2);const finalInventoryItems=[...currentRiddle.ingredients,...distractors].sort(()=>0.5-Math.random());finalInventoryItems.forEach(itemName=>{const item=document.createElement('div');item.classList.add('item');item.style.backgroundImage=`url(${itemTextures[itemName]})`;item.dataset.item=itemName;item.draggable=true;item.addEventListener('dragstart',onDragStart);inventory.appendChild(item);});feedback.textContent='';}
function onDragStart(e){draggedElement=e.target;setTimeout(()=>e.target.classList.add('dragging'),0);}
function onDropToGrid(e){e.preventDefault();const slot=e.target.closest('.grid-slot');if(!slot||slot.firstChild||!draggedElement)return;const index=parseInt(slot.dataset.index,10);gridState[index]=draggedElement.dataset.item;slot.appendChild(draggedElement);draggedElement.classList.remove('dragging');draggedElement=null;}
function onDropToInventory(e){e.preventDefault();if(!draggedElement||e.target.closest('.item'))return;const oldIndex=gridState.indexOf(draggedElement.dataset.item);if(oldIndex>-1){gridState[oldIndex]=null;}
inventory.appendChild(draggedElement);draggedElement.classList.remove('dragging');draggedElement=null;}
function checkCrafting(){const itemsInGrid=gridState.filter(item=>item!==null).sort();if(JSON.stringify(itemsInGrid)===JSON.stringify(currentRiddle.ingredients)){feedback.textContent='¡Crafteo exitoso!';feedback.className='text-success';setTimeout(()=>submitWin(roomName,stageName,winToken),1500);}else{feedback.textContent='La combinación es incorrecta. Reiniciando...';feedback.className='text-danger';setTimeout(setupGame,2000);}}
craftButton.addEventListener('click',checkCrafting);setupGame();}